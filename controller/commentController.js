const Post = require("../model/post.js");
const User = require("../model/user");
const Comment = require("../model/comment");
const jwt = require("jsonwebtoken");
const moment = require("moment");


//댓글 조회하기 (get)
// const comment = async (req, res) => {
//   const {
//     params: {id},
//   } = req;
//   try{
//     const comment = await Comment.findById(id);

//   } catch (error) {

//   }

//}

//댓글 작성하기
const commentUpload = async (req, res) => {

  const { insta_Id } = res.locals.user;
  const { name } = await User.findOne({ insta_Id });
  const {
    params: { id },
    body: { content, post_Id },
  } = req;
  console.log("==== 클라이언트가 넘겨주는 값 =====")
  console.log(req.body.post_Id)
  console.log(req.body.content)
  const post = await Post.findOne({ post_Id: post_Id }).populate('comments');


  console.log("==== post 찾은 것 =====")
  console.log(post)

  try {
    const newComment = await Comment.create({
      text: content,
      createAt: moment().format("YYYY년 MM월 DD일 HH:mm"),
      name,
      profile_img: "data:image/jpeg;base64,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"
    });
    post.save();
    post.comments.push(newComment);

    const comments = post.comments
    const realTimeComment = comments[comments.length - 1];
    res.send({ realTimeComment });

  } catch (error) {

    res.status(400).send({
      error: '댓글 작성 중 오류가 발생했습니다.'
    });
    console.log(error);

  }
};


//댓글 수정하기
const commentEdit = async (req, res) => {
  const {
    params: { id },
    body: { text }
  } = req;
  try {

    await Comment.findByIdAndUpdate(id, { text });
    res.send({
      message: '댓글 수정 완료!'
    })

  } catch (error) {

    res.send({
      error: '댓글 수정 중 오류가 발생했습니다.'
    });
    console.log(error);

  }
}

//삭제하기
const commentDelete = async (req, res) => {
  const {
    params: { id }
  } = req;
  try {

    await Comment.findByIdAndDelete(id);
    res.send({
      //comment_id로 다시 보내주기.
    });

  } catch (error) {

    res.send({
      error: '댓글 삭제 중 오류가 발생했습니다.'
    });
    console.log(error);

  }
}


module.exports = { commentDelete, commentEdit, commentUpload };